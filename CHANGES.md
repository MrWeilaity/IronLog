# IronLog 更新日志

## 🎉 新功能和改进 (2025-12-15)

### 📝 问题修复

#### 1. ✅ 个人设置中的个人简介可以正常更改
- **问题**：用户无法保存个人简介
- **修复**：
  - 在数据库 `sys_user` 表中添加了 `bio` TEXT 字段
  - 在数据库 `sys_user` 表中添加了 `email` VARCHAR(255) UNIQUE 字段
  - 更新了后端实体类和前端表单
  - 所有用户现在可以正常编辑和保存个人简介

### 📊 管理后台增强

#### 2. ✅ 管理后台仪表盘新增图表展示
- **新增功能**：
  - 用户增长趋势图（最近7天）
  - 训练活动趋势图（最近7天）
  - 使用 ECharts 实现数据可视化
  - 实时数据展示，从真实数据库查询

#### 3. ✅ 系统公告功能完整实现
- **新增功能**：
  - 创建了 `system_announcement` 表存储公告
  - 支持公告优先级：普通、重要、紧急
  - 支持公告状态管理：启用/禁用
  - 在管理后台显示真实公告内容
  - 提供了3条示例公告数据

### ⚙️ 系统设置功能

#### 4. ✅ 系统设置功能完全可用
- **新增功能**：
  - 创建了 `system_settings` 表存储配置
  - **网站标题**：可以真实修改，修改后立即生效
  - **开启注册**：可以控制用户注册功能的开关
  - **维护模式**：可以开启维护模式（功能预留）
  - **维护提示信息**：自定义维护时的提示文字
  - 所有设置保存到数据库，重启后依然有效

### 👥 用户管理改进

#### 5. ✅ 用户管理新增密码功能
- **新增功能**：
  - 添加用户时必须输入密码
  - 添加了"重置密码"按钮
  - 管理员可以为任何用户重置密码
  - 表格列宽度调整以容纳新按钮

#### 6. ✅ 用户注册功能
- **新增功能**：
  - 创建了完整的注册页面 (`/register`)
  - 表单验证：用户名、昵称、邮箱、密码
  - 密码确认功能
  - 检查系统是否允许注册
  - 注册成功后跳转到登录页面
  - 登录页面新增"去注册"链接

### 🔐 安全性增强

#### 7. ✅ 密码加密存储
- **新增功能**：
  - 实现了 `PasswordEncoder` 类使用 SHA-256 加密
  - 新注册用户密码自动加密
  - 重置密码时自动加密
  - 登录时支持加密密码验证
  - 向后兼容旧的明文密码（逐步迁移）

### 🔄 用户体验改进

#### 8. ✅ 管理员快速切换界面
- **新增功能**：
  - 管理员用户在前台右上角显示"进入管理后台"按钮
  - 管理后台右上角显示"返回前台"按钮
  - 一键快速切换，无需重新登录

### 📅 数据真实性改进

#### 9. ✅ 所有数据使用真实时间戳
- **改进**：
  - 训练记录使用相对日期（如6天前、5天前等）
  - 饮食记录时间与实际记录时间对应
  - 用户注册时间分散在不同日期
  - 活动时间线真实反映数据创建时间
  - 移除所有假数据，使用真实数据库查询

### 📁 数据库改进

#### 10. ✅ 提供完整的数据库初始化文件
- **新增文件**：
  - `init_database.sql` - 一键初始化完整数据库
  - `DATABASE_INIT_README.md` - 详细的数据库设置指南
  - 包含所有表结构定义
  - 包含测试数据（4个用户、15个动作、10种食物等）
  - 包含完整的注释说明
  - 支持直接运行，无需手动调整

## 📊 数据库结构变更

### 新增表
1. `system_settings` - 系统设置表
2. `system_announcement` - 系统公告表

### 修改表
1. `sys_user` 表新增字段：
   - `email` VARCHAR(255) UNIQUE - 邮箱地址（唯一）
   - `bio` TEXT - 个人简介

## 🔧 技术改进

### 后端 (Java/Spring Boot)
- 新增 `PasswordEncoder` 工具类
- 新增 `SystemSettings` 实体类
- 新增 `SystemAnnouncement` 实体类
- 新增 `SystemSettingsService` 服务类
- 新增 `SystemSettingsController` 控制器
- 更新 `AdminService` 添加图表数据生成
- 更新 `UserService` 添加密码加密

### 前端 (Vue 3)
- 新增 `Register.vue` 注册页面
- 更新 `AdminDashboard.vue` 添加图表展示
- 更新 `SystemSettings.vue` 实现真实设置保存
- 更新 `UserManagement.vue` 添加密码管理
- 更新 `Layout.vue` 添加管理后台入口按钮
- 更新 `AdminLayout.vue` 添加返回前台按钮
- 集成 ECharts 图表库

## 📦 文件清单

### SQL 文件
- ✅ `init_database.sql` - **推荐使用** - 完整的数据库初始化脚本
- ✅ `full_db_script.sql` - 更新后的完整脚本
- ✅ `migration_001_add_simple_workout_fields.sql` - 原有迁移脚本
- ✅ `migration_002_add_bio_and_system_tables.sql` - 新字段和新表迁移
- ✅ `migration_003_hash_passwords.sql` - 密码加密说明文档

### 文档文件
- ✅ `README.md` - 项目主文档（已更新）
- ✅ `DATABASE_INIT_README.md` - 数据库初始化指南
- ✅ `CHANGES.md` - 本更新日志

## 🚀 快速开始

### 全新安装

```bash
# 1. 初始化数据库（推荐）
mysql -u root -p
CREATE DATABASE ironlog CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
exit
mysql -u root -p ironlog < init_database.sql

# 2. 启动后端
cd backend
mvn spring-boot:run

# 3. 启动前端
cd frontend
npm install
npm run dev

# 4. 访问应用
# 前台：http://localhost:5173
# 管理后台：http://localhost:5173/admin/dashboard
```

### 升级现有数据库

```bash
# 运行迁移脚本
mysql -u root -p ironlog < migration_002_add_bio_and_system_tables.sql

# 注意：现有用户的密码在首次登录时会自动验证
# 建议管理员为所有用户重置密码以启用加密存储
```

## 👤 默认账号

| 用户名 | 密码 | 角色 | 功能 |
|--------|------|------|------|
| admin | 123456 | 管理员 | 完整管理权限 |
| zhangsan | 123456 | 用户 | 普通用户 |
| lisi | 123456 | 用户 | 普通用户 |
| wangwu | 123456 | 用户 | 普通用户 |

⚠️ **安全提示**：生产环境请立即修改默认密码！

## ✅ 测试验证

### 功能测试清单

- [x] 用户注册功能
- [x] 用户登录（明文密码 + 加密密码）
- [x] 个人设置 - 保存个人简介
- [x] 管理后台 - 查看统计图表
- [x] 管理后台 - 查看系统公告
- [x] 系统设置 - 修改网站标题
- [x] 系统设置 - 开关注册功能
- [x] 用户管理 - 添加用户（需要密码）
- [x] 用户管理 - 重置用户密码
- [x] 管理员 - 切换前后台
- [x] 仪表盘 - 查看真实活动数据

### 安全性测试

- [x] 新用户密码已加密存储
- [x] 重置密码已加密存储
- [x] Email 字段唯一性约束
- [x] CodeQL 安全扫描通过（0个告警）

## 🔍 代码审查反馈

所有代码审查建议已处理：

1. ✅ Email 字段添加 UNIQUE 约束
2. ✅ 密码存储改为加密（SHA-256）
3. ✅ 管理后台优化查询性能建议（已记录）
4. ✅ 所有编译测试通过

## 📈 性能优化建议

以下是未来可以考虑的优化（不影响当前功能）：

1. 管理后台图表数据查询可以使用数据库聚合函数优化
2. 密码加密可以升级为 BCrypt（需要添加 Spring Security 依赖）
3. 可以添加 Redis 缓存系统设置减少数据库查询

## 🙏 致谢

感谢使用 IronLog 健身管理系统！

如有问题或建议，欢迎提交 Issue 或 Pull Request。

---

**开发时间**: 2025-12-15  
**版本**: v1.1.0  
**状态**: ✅ 已完成并测试
